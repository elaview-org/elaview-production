---
description: Expo and React Native development patterns
globs:
  - "apps/mobile/**"
  - "clients/mobile/**"
alwaysApply: false
---

# Mobile Development

## Tech Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| Expo SDK | 54 | Development platform |
| React Native | 0.76+ | UI framework |
| Expo Router | v6 | File-based navigation |
| React Native Reanimated | v4 | Animations |
| Apollo Client | 3.x | GraphQL client |
| expo-image | Latest | Optimized image loading |
| expo-camera | Latest | Verification photo capture |
| expo-location | Latest | GPS validation |
| expo-secure-store | Latest | Secure token storage |
| expo-notifications | Latest | Push notifications |

---

## Expo SDK 54 Specifics

### New Architecture

Expo SDK 54 uses the **New Architecture** by default:
- TurboModules for native modules
- Fabric for UI rendering
- Improved performance and memory usage

```json
// app.json
{
  "expo": {
    "newArchEnabled": true,
    "plugins": [
      "expo-router",
      "expo-secure-store",
      [
        "expo-camera",
        {
          "cameraPermission": "Allow Elaview to take verification photos"
        }
      ],
      [
        "expo-location",
        {
          "locationWhenInUsePermission": "Allow Elaview to verify installation location"
        }
      ]
    ]
  }
}
```

### EAS Development Builds (REQUIRED - NOT Expo Go)

**CRITICAL**: Elaview mobile app requires EAS custom development builds. **Expo Go WILL NOT WORK**.

**Why?**
- `newArchEnabled: true` - Expo Go doesn't support the New Architecture
- Reanimated 4.x requires `react-native-reanimated/plugin` in Babel config
- Native dependencies (`react-native-reanimated`, `react-native-gesture-handler`, `react-native-svg`) work better with custom builds

**Setup:**

```bash
# 1. Install EAS CLI globally
pnpm add -g eas-cli

# 2. Login to EAS
eas login

# 3. Build development client
cd clients/mobile

# iOS (simulator - Mac only):
eas build --profile development --platform ios

# Android (emulator/device):
eas build --profile development --platform android
```

**First build takes 15-20 minutes.** Subsequent builds are faster (~5-10 min).

**After build completes:**
- **iOS**: Download `.tar.gz`, drag to iOS Simulator
- **Android**: Download APK, install on emulator/device (`adb install app.apk`)

**Start dev server with custom build:**
```bash
npx expo start --dev-client
```

**Configuration files:**

```json
// eas.json
{
  "cli": {
    "version": ">= 14.0.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "ios": {
        "simulator": true
      },
      "android": {
        "buildType": "apk"
      }
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {
      "autoIncrement": true
    }
  }
}
```

```javascript
// babel.config.js
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: ['react-native-reanimated/plugin'], // ← Required for Reanimated 4.x
  };
};
```

**When to rebuild:**
- After adding native dependencies
- After changing `app.json` plugins
- After updating Expo SDK version
- NOT needed for JavaScript/TypeScript code changes (hot reload works)

### Reanimated v4

Use Reanimated v4 for animations:

```typescript
// apps/mobile/src/components/AnimatedCard.tsx
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withSpring,
  withTiming,
} from 'react-native-reanimated';

export function AnimatedCard({ children, onPress }: Props) {
  const scale = useSharedValue(1);
  
  const animatedStyle = useAnimatedStyle(() => ({
    transform: [{ scale: scale.value }],
  }));
  
  const handlePressIn = () => {
    scale.value = withSpring(0.95);
  };
  
  const handlePressOut = () => {
    scale.value = withSpring(1);
  };
  
  return (
    <Pressable onPressIn={handlePressIn} onPressOut={handlePressOut} onPress={onPress}>
      <Animated.View style={animatedStyle}>
        {children}
      </Animated.View>
    </Pressable>
  );
}
```

---

## Expo Router v6

### CRITICAL: Navigation Behavior Change

In Expo Router v6, `router.navigate()` now behaves like `router.push()`:

```typescript
// ❌ OLD (v5): navigate replaced the current screen
router.navigate('/booking/123');

// ✅ NEW (v6): navigate pushes to the stack (same as push)
router.navigate('/booking/123'); // Pushes new screen

// To replace (old navigate behavior), use:
router.replace('/booking/123');
```

### File Structure

```
apps/mobile/
├── app/
│   ├── _layout.tsx                 # Root layout (providers)
│   ├── index.tsx                   # Splash/redirect
│   │
│   ├── (auth)/                     # Auth group (unauthenticated)
│   │   ├── _layout.tsx             # Auth stack layout
│   │   ├── login.tsx
│   │   ├── register.tsx
│   │   ├── forgot-password.tsx
│   │   └── verify-email.tsx
│   │
│   └── (app)/                      # Main app group (authenticated)
│       ├── _layout.tsx             # Tab navigator layout
│       │
│       ├── (advertiser)/           # Advertiser tab screens
│       │   ├── _layout.tsx         # Advertiser tab config
│       │   ├── index.tsx           # Home/Dashboard
│       │   ├── search/
│       │   │   ├── index.tsx       # Search spaces
│       │   │   └── [id].tsx        # Space detail
│       │   ├── bookings/
│       │   │   ├── index.tsx       # My bookings list
│       │   │   ├── [id]/
│       │   │   │   ├── index.tsx   # Booking detail
│       │   │   │   ├── pay.tsx     # Payment screen
│       │   │   │   └── verify.tsx  # Review verification
│       │   └── profile/
│       │       └── index.tsx
│       │
│       └── (owner)/                # Space owner tab screens
│           ├── _layout.tsx         # Owner tab config
│           ├── index.tsx           # Dashboard
│           ├── spaces/
│           │   ├── index.tsx       # My spaces list
│           │   ├── new.tsx         # Create space
│           │   └── [id]/
│           │       ├── index.tsx   # Space detail
│           │       └── edit.tsx    # Edit space
│           ├── bookings/
│           │   ├── index.tsx       # Booking requests
│           │   └── [id]/
│           │       ├── index.tsx   # Booking detail
│           │       ├── download.tsx # Download creative
│           │       └── verify.tsx  # Upload verification
│           ├── earnings/
│           │   └── index.tsx
│           └── profile/
│               └── index.tsx
│
├── src/
│   ├── components/                 # Mobile-specific components
│   ├── hooks/                      # Mobile-specific hooks
│   ├── utils/                      # Mobile utilities
│   └── constants/                  # Mobile constants
│
└── app.json
```

### Root Layout (Providers)

```typescript
// apps/mobile/app/_layout.tsx
import { Stack } from 'expo-router';
import { ApolloProvider } from '@apollo/client';
import { GestureHandlerRootView } from 'react-native-gesture-handler';
import { SafeAreaProvider } from 'react-native-safe-area-context';
import { StripeProvider } from '@stripe/stripe-react-native';

import { apolloClient } from '@/src/lib/apollo';
import { AuthProvider } from '@/src/contexts/AuthContext';
import { NotificationProvider } from '@/src/contexts/NotificationContext';

export default function RootLayout() {
  return (
    <GestureHandlerRootView style={{ flex: 1 }}>
      <SafeAreaProvider>
        <ApolloProvider client={apolloClient}>
          <StripeProvider publishableKey={process.env.EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY!}>
            <AuthProvider>
              <NotificationProvider>
                <Stack screenOptions={{ headerShown: false }}>
                  <Stack.Screen name="(auth)" />
                  <Stack.Screen name="(app)" />
                </Stack>
              </NotificationProvider>
            </AuthProvider>
          </StripeProvider>
        </ApolloProvider>
      </SafeAreaProvider>
    </GestureHandlerRootView>
  );
}
```

### Tab Navigator Layout

```typescript
// apps/mobile/app/(app)/(advertiser)/_layout.tsx
import { Tabs } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';

export default function AdvertiserLayout() {
  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: '#3B82F6',
        tabBarInactiveTintColor: '#6B7280',
        headerShown: false,
      }}
    >
      <Tabs.Screen
        name="index"
        options={{
          title: 'Home',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="home-outline" size={size} color={color} />
          ),
          tabBarTestID: 'tab-home',
        }}
      />
      <Tabs.Screen
        name="search"
        options={{
          title: 'Search',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="search-outline" size={size} color={color} />
          ),
          tabBarTestID: 'tab-search',
        }}
      />
      <Tabs.Screen
        name="bookings"
        options={{
          title: 'Bookings',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="calendar-outline" size={size} color={color} />
          ),
          tabBarTestID: 'tab-bookings',
        }}
      />
      <Tabs.Screen
        name="profile"
        options={{
          title: 'Profile',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="person-outline" size={size} color={color} />
          ),
          tabBarTestID: 'tab-profile',
        }}
      />
    </Tabs>
  );
}
```

---

## Navigation Patterns

### Programmatic Navigation

```typescript
import { useRouter, useLocalSearchParams, useSegments } from 'expo-router';

export function BookingCard({ booking }: { booking: Booking }) {
  const router = useRouter();
  
  const handlePress = () => {
    // Push to booking detail (v6: navigate = push)
    router.navigate(`/bookings/${booking.id}`);
    
    // Or explicitly:
    router.push(`/bookings/${booking.id}`);
  };
  
  const handleComplete = () => {
    // Replace current screen (go back won't return here)
    router.replace('/bookings');
  };
  
  const handleCancel = () => {
    // Go back to previous screen
    router.back();
  };
  
  return (
    <Pressable onPress={handlePress} testID={`booking-card-${booking.id}`}>
      {/* ... */}
    </Pressable>
  );
}
```

### Deep Linking from Notifications

```typescript
// apps/mobile/src/hooks/useNotificationHandler.ts
import { useEffect } from 'react';
import { useRouter } from 'expo-router';
import * as Notifications from 'expo-notifications';

export function useNotificationHandler() {
  const router = useRouter();
  
  useEffect(() => {
    // Handle notification tap
    const subscription = Notifications.addNotificationResponseReceivedListener(
      (response) => {
        const data = response.notification.request.content.data;
        
        if (data.bookingId) {
          router.navigate(`/bookings/${data.bookingId}`);
        } else if (data.spaceId) {
          router.navigate(`/spaces/${data.spaceId}`);
        }
      }
    );
    
    return () => subscription.remove();
  }, [router]);
}
```

### Protected Routes

```typescript
// apps/mobile/app/(app)/_layout.tsx
import { Redirect, Stack } from 'expo-router';
import { useAuth } from '@/src/contexts/AuthContext';

export default function AppLayout() {
  const { user, isLoading } = useAuth();
  
  if (isLoading) {
    return <LoadingScreen />;
  }
  
  if (!user) {
    return <Redirect href="/login" />;
  }
  
  // Route based on user role
  if (user.role === 'ADVERTISER') {
    return <Redirect href="/(advertiser)" />;
  }
  
  return <Redirect href="/(owner)" />;
}
```

---

## Key Libraries

### expo-camera (Verification Photos)

```typescript
// apps/mobile/src/components/VerificationCamera.tsx
import { CameraView, useCameraPermissions } from 'expo-camera';
import * as MediaLibrary from 'expo-media-library';
import * as Location from 'expo-location';

interface Props {
  onPhotoCapture: (photo: CapturedPhoto) => void;
  requiredCount: number;
}

interface CapturedPhoto {
  uri: string;
  latitude: number;
  longitude: number;
  capturedAt: Date;
}

export function VerificationCamera({ onPhotoCapture, requiredCount }: Props) {
  const [permission, requestPermission] = useCameraPermissions();
  const cameraRef = useRef<CameraView>(null);
  
  const capturePhoto = async () => {
    if (!cameraRef.current) return;
    
    // Capture photo
    const photo = await cameraRef.current.takePictureAsync({
      quality: 0.8,
      exif: true,
    });
    
    // Get current location
    const location = await Location.getCurrentPositionAsync({
      accuracy: Location.Accuracy.High,
    });
    
    onPhotoCapture({
      uri: photo.uri,
      latitude: location.coords.latitude,
      longitude: location.coords.longitude,
      capturedAt: new Date(),
    });
  };
  
  if (!permission?.granted) {
    return (
      <View style={styles.container}>
        <Text>Camera permission is required for verification</Text>
        <Button title="Grant Permission" onPress={requestPermission} />
      </View>
    );
  }
  
  return (
    <View style={styles.container}>
      <CameraView
        ref={cameraRef}
        style={styles.camera}
        facing="back"
      >
        <View style={styles.overlay}>
          <Text style={styles.instructions}>
            Take {requiredCount} photos of the installation
          </Text>
        </View>
      </CameraView>
      
      <Pressable
        style={styles.captureButton}
        onPress={capturePhoto}
        testID="capture-button"
      >
        <View style={styles.captureButtonInner} />
      </Pressable>
    </View>
  );
}
```

### expo-location (GPS Validation)

```typescript
// apps/mobile/src/hooks/useLocationValidation.ts
import * as Location from 'expo-location';

interface LocationValidationResult {
  isValid: boolean;
  distanceMeters: number;
  currentLocation: {
    latitude: number;
    longitude: number;
  } | null;
  error?: string;
}

export function useLocationValidation() {
  const [permissionStatus, setPermissionStatus] = useState<Location.PermissionStatus>();
  
  useEffect(() => {
    (async () => {
      const { status } = await Location.requestForegroundPermissionsAsync();
      setPermissionStatus(status);
    })();
  }, []);
  
  const validateLocation = async (
    targetLat: number,
    targetLng: number,
    radiusMeters: number
  ): Promise<LocationValidationResult> => {
    try {
      if (permissionStatus !== 'granted') {
        return {
          isValid: false,
          distanceMeters: 0,
          currentLocation: null,
          error: 'Location permission not granted',
        };
      }
      
      const location = await Location.getCurrentPositionAsync({
        accuracy: Location.Accuracy.High,
      });
      
      const distance = calculateDistance(
        location.coords.latitude,
        location.coords.longitude,
        targetLat,
        targetLng
      );
      
      return {
        isValid: distance <= radiusMeters,
        distanceMeters: Math.round(distance),
        currentLocation: {
          latitude: location.coords.latitude,
          longitude: location.coords.longitude,
        },
      };
    } catch (error) {
      return {
        isValid: false,
        distanceMeters: 0,
        currentLocation: null,
        error: 'Failed to get current location',
      };
    }
  };
  
  return { validateLocation, permissionStatus };
}

// Haversine formula
function calculateDistance(
  lat1: number, lon1: number,
  lat2: number, lon2: number
): number {
  const R = 6371e3; // Earth's radius in meters
  const φ1 = (lat1 * Math.PI) / 180;
  const φ2 = (lat2 * Math.PI) / 180;
  const Δφ = ((lat2 - lat1) * Math.PI) / 180;
  const Δλ = ((lon2 - lon1) * Math.PI) / 180;

  const a =
    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c;
}
```

### expo-image (Optimized Images)

```typescript
// apps/mobile/src/components/SpaceImage.tsx
import { Image } from 'expo-image';

const blurhash = 'L6PZfSi_.AyE_3t7t7R**0o#DgR4'; // Placeholder blur

interface Props {
  uri: string;
  style?: StyleProp<ImageStyle>;
  testID?: string;
}

export function SpaceImage({ uri, style, testID }: Props) {
  return (
    <Image
      source={{ uri }}
      style={style}
      placeholder={blurhash}
      contentFit="cover"
      transition={200}
      testID={testID}
    />
  );
}

// For galleries with multiple images
export function SpaceGallery({ photos }: { photos: string[] }) {
  return (
    <FlatList
      data={photos}
      horizontal
      showsHorizontalScrollIndicator={false}
      renderItem={({ item, index }) => (
        <SpaceImage
          uri={item}
          style={styles.galleryImage}
          testID={`gallery-image-${index}`}
        />
      )}
      keyExtractor={(item, index) => `${item}-${index}`}
    />
  );
}
```

### expo-secure-store (Token Storage)

```typescript
// apps/mobile/src/lib/auth-storage.ts
import * as SecureStore from 'expo-secure-store';

const ACCESS_TOKEN_KEY = 'elaview_access_token';
const REFRESH_TOKEN_KEY = 'elaview_refresh_token';

export const authStorage = {
  async getAccessToken(): Promise<string | null> {
    return SecureStore.getItemAsync(ACCESS_TOKEN_KEY);
  },
  
  async setAccessToken(token: string): Promise<void> {
    await SecureStore.setItemAsync(ACCESS_TOKEN_KEY, token);
  },
  
  async getRefreshToken(): Promise<string | null> {
    return SecureStore.getItemAsync(REFRESH_TOKEN_KEY);
  },
  
  async setRefreshToken(token: string): Promise<void> {
    await SecureStore.setItemAsync(REFRESH_TOKEN_KEY, token);
  },
  
  async setTokens(accessToken: string, refreshToken: string): Promise<void> {
    await Promise.all([
      SecureStore.setItemAsync(ACCESS_TOKEN_KEY, accessToken),
      SecureStore.setItemAsync(REFRESH_TOKEN_KEY, refreshToken),
    ]);
  },
  
  async clearTokens(): Promise<void> {
    await Promise.all([
      SecureStore.deleteItemAsync(ACCESS_TOKEN_KEY),
      SecureStore.deleteItemAsync(REFRESH_TOKEN_KEY),
    ]);
  },
};
```

### expo-notifications (Push Notifications)

```typescript
// apps/mobile/src/lib/notifications.ts
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import Constants from 'expo-constants';

// Configure notification behavior
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

export async function registerForPushNotifications(): Promise<string | null> {
  if (!Device.isDevice) {
    console.log('Push notifications only work on physical devices');
    return null;
  }
  
  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;
  
  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }
  
  if (finalStatus !== 'granted') {
    console.log('Push notification permission not granted');
    return null;
  }
  
  const token = await Notifications.getExpoPushTokenAsync({
    projectId: Constants.expoConfig?.extra?.eas?.projectId,
  });
  
  return token.data;
}

export async function setBadgeCount(count: number): Promise<void> {
  await Notifications.setBadgeCountAsync(count);
}
```

---

## Component Patterns

### Standard Component Structure

```typescript
// apps/mobile/src/components/BookingCard/BookingCard.tsx
import { View, Text, Pressable, StyleSheet } from 'react-native';
import { Booking } from '@elaview/graphql/generated';
import { BookingStatusBadge } from '@elaview/features/bookings';
import { SpaceImage } from '../SpaceImage';
import { formatCurrency, formatDateRange } from '@elaview/shared/utils';

interface BookingCardProps {
  booking: Booking;
  onPress: () => void;
  testID?: string;
}

export function BookingCard({ booking, onPress, testID }: BookingCardProps) {
  return (
    <Pressable
      style={styles.container}
      onPress={onPress}
      testID={testID}
      accessibilityRole="button"
      accessibilityLabel={`Booking for ${booking.space.title}`}
    >
      <SpaceImage
        uri={booking.space.photos[0]}
        style={styles.image}
        testID={`${testID}-image`}
      />
      
      <View style={styles.content}>
        <View style={styles.header}>
          <Text style={styles.title} numberOfLines={1}>
            {booking.space.title}
          </Text>
          <BookingStatusBadge status={booking.status} />
        </View>
        
        <Text style={styles.dates} testID={`${testID}-dates`}>
          {formatDateRange(booking.dateRange.startDate, booking.dateRange.endDate)}
        </Text>
        
        <Text style={styles.price} testID={`${testID}-price`}>
          {formatCurrency(booking.total)}
        </Text>
      </View>
    </Pressable>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
    marginHorizontal: 16,
    marginVertical: 8,
  },
  image: {
    width: 100,
    height: 100,
  },
  content: {
    flex: 1,
    padding: 12,
    justifyContent: 'space-between',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  title: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1F2937',
    flex: 1,
    marginRight: 8,
  },
  dates: {
    fontSize: 14,
    color: '#6B7280',
    marginTop: 4,
  },
  price: {
    fontSize: 16,
    fontWeight: '700',
    color: '#3B82F6',
    marginTop: 4,
  },
});
```

### Co-located Exports

```typescript
// apps/mobile/src/components/BookingCard/index.ts
export { BookingCard } from './BookingCard';
export type { BookingCardProps } from './BookingCard';
```

### testID Convention

Always include testID for E2E testing:

```typescript
// Pattern: [component-type]-[identifier]-[element]
testID="booking-card-123"
testID="booking-card-123-image"
testID="booking-card-123-status"
testID="pay-button"
testID="capture-button"
testID="tab-home"
testID="input-email"
testID="input-password"
testID="error-message"
```

---

## Screen Patterns

### List Screen with Pull-to-Refresh

```typescript
// apps/mobile/app/(app)/(advertiser)/bookings/index.tsx
import { FlatList, RefreshControl, View, Text } from 'react-native';
import { useMyBookingsQuery } from '@elaview/graphql/generated';
import { BookingCard } from '@/src/components/BookingCard';
import { useRouter } from 'expo-router';

export default function BookingsScreen() {
  const router = useRouter();
  const { data, loading, refetch, fetchMore } = useMyBookingsQuery({
    variables: { first: 20 },
  });
  
  const bookings = data?.myBookings.edges.map((e) => e.node) ?? [];
  const hasNextPage = data?.myBookings.pageInfo.hasNextPage ?? false;
  
  const loadMore = () => {
    if (!hasNextPage || loading) return;
    
    fetchMore({
      variables: {
        after: data?.myBookings.pageInfo.endCursor,
      },
    });
  };
  
  if (!loading && bookings.length === 0) {
    return (
      <View style={styles.emptyContainer} testID="empty-state">
        <Text style={styles.emptyTitle}>No bookings yet</Text>
        <Text style={styles.emptyMessage}>
          Search for advertising spaces to get started
        </Text>
      </View>
    );
  }
  
  return (
    <FlatList
      data={bookings}
      keyExtractor={(item) => item.id}
      renderItem={({ item }) => (
        <BookingCard
          booking={item}
          onPress={() => router.navigate(`/bookings/${item.id}`)}
          testID={`booking-card-${item.id}`}
        />
      )}
      contentContainerStyle={styles.list}
      refreshControl={
        <RefreshControl refreshing={loading} onRefresh={refetch} />
      }
      onEndReached={loadMore}
      onEndReachedThreshold={0.5}
      testID="bookings-list"
    />
  );
}
```

### Detail Screen with Actions

```typescript
// apps/mobile/app/(app)/(advertiser)/bookings/[id]/index.tsx
import { View, ScrollView, Alert } from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';
import { useBookingQuery, useCancelBookingMutation } from '@elaview/graphql/generated';
import { BookingTimeline, BookingActions } from '@elaview/features/bookings';

export default function BookingDetailScreen() {
  const { id } = useLocalSearchParams<{ id: string }>();
  const router = useRouter();
  
  const { data, loading, error } = useBookingQuery({
    variables: { id },
  });
  
  const [cancelBooking, { loading: cancelling }] = useCancelBookingMutation();
  
  const booking = data?.booking;
  
  const handleCancel = () => {
    Alert.alert(
      'Cancel Booking',
      'Are you sure you want to cancel this booking?',
      [
        { text: 'No', style: 'cancel' },
        {
          text: 'Yes, Cancel',
          style: 'destructive',
          onPress: async () => {
            await cancelBooking({ variables: { id } });
            router.back();
          },
        },
      ]
    );
  };
  
  const handlePay = () => {
    router.navigate(`/bookings/${id}/pay`);
  };
  
  const handleApprove = () => {
    router.navigate(`/bookings/${id}/verify`);
  };
  
  if (loading) return <LoadingScreen />;
  if (error) return <ErrorScreen error={error} />;
  if (!booking) return <NotFoundScreen />;
  
  return (
    <ScrollView style={styles.container} testID="booking-detail">
      <BookingHeader booking={booking} />
      <BookingTimeline booking={booking} />
      <BookingPricing booking={booking} />
      
      <BookingActions
        booking={booking}
        onPay={handlePay}
        onApprove={handleApprove}
        onCancel={handleCancel}
        cancelling={cancelling}
      />
    </ScrollView>
  );
}
```

---

## Form Patterns

### Form with Validation

```typescript
// apps/mobile/src/components/forms/CreateSpaceForm.tsx
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { createSpaceSchema, CreateSpaceInput } from '@elaview/shared/schemas';
import { TextInput, Button, ErrorText } from '@/src/components/ui';

interface Props {
  onSubmit: (data: CreateSpaceInput) => Promise<void>;
  spaceTypes: SpaceType[];
}

export function CreateSpaceForm({ onSubmit, spaceTypes }: Props) {
  const {
    control,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm<CreateSpaceInput>({
    resolver: zodResolver(createSpaceSchema),
  });
  
  return (
    <View style={styles.container}>
      <Controller
        control={control}
        name="title"
        render={({ field: { onChange, onBlur, value } }) => (
          <View>
            <TextInput
              label="Title"
              value={value}
              onChangeText={onChange}
              onBlur={onBlur}
              placeholder="e.g., Prime Window Display on Main St"
              error={!!errors.title}
              testID="input-title"
            />
            {errors.title && (
              <ErrorText testID="error-title">{errors.title.message}</ErrorText>
            )}
          </View>
        )}
      />
      
      {/* Space type picker - reads from API, never hardcoded */}
      <Controller
        control={control}
        name="spaceTypeId"
        render={({ field: { onChange, value } }) => (
          <SpaceTypePicker
            spaceTypes={spaceTypes}
            value={value}
            onChange={onChange}
            testID="picker-space-type"
          />
        )}
      />
      
      {/* ... more fields ... */}
      
      <Button
        title="Create Space"
        onPress={handleSubmit(onSubmit)}
        loading={isSubmitting}
        disabled={isSubmitting}
        testID="submit-button"
      />
    </View>
  );
}
```

---

## Error Handling

```typescript
// apps/mobile/src/components/ErrorBoundary.tsx
import { ErrorBoundary as ReactErrorBoundary } from 'react-error-boundary';
import * as Sentry from '@sentry/react-native';

function ErrorFallback({ error, resetErrorBoundary }: FallbackProps) {
  return (
    <View style={styles.container} testID="error-fallback">
      <Text style={styles.title}>Something went wrong</Text>
      <Text style={styles.message}>{error.message}</Text>
      <Button title="Try Again" onPress={resetErrorBoundary} />
    </View>
  );
}

export function AppErrorBoundary({ children }: { children: React.ReactNode }) {
  return (
    <ReactErrorBoundary
      FallbackComponent={ErrorFallback}
      onError={(error, info) => {
        Sentry.captureException(error, {
          extra: { componentStack: info.componentStack },
        });
      }}
    >
      {children}
    </ReactErrorBoundary>
  );
}
```

---

## Testing Patterns

### Component Tests

```typescript
// apps/mobile/src/components/BookingCard/BookingCard.test.tsx
import { render, fireEvent } from '@testing-library/react-native';
import { BookingCard } from './BookingCard';
import { createMockBooking } from '@elaview/shared/testing/factories';

describe('BookingCard', () => {
  const mockBooking = createMockBooking({
    status: 'PAID',
    total: 150,
  });
  
  it('renders booking information', () => {
    const { getByTestId, getByText } = render(
      <BookingCard
        booking={mockBooking}
        onPress={jest.fn()}
        testID="booking-card"
      />
    );
    
    expect(getByText(mockBooking.space.title)).toBeTruthy();
    expect(getByText('$150.00')).toBeTruthy();
    expect(getByTestId('booking-card')).toBeTruthy();
  });
  
  it('calls onPress when tapped', () => {
    const onPress = jest.fn();
    const { getByTestId } = render(
      <BookingCard
        booking={mockBooking}
        onPress={onPress}
        testID="booking-card"
      />
    );
    
    fireEvent.press(getByTestId('booking-card'));
    expect(onPress).toHaveBeenCalledTimes(1);
  });
});
```
